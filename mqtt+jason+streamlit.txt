# README - Gesti√≥ Centre Control Bomba

## 1. Context
Aquest projecte implementa un sistema de **control autom√†tic d‚Äôuna bomba d‚Äôaigua** amb monitoritzaci√≥ en temps real, gesti√≥ de maniobres i registre d‚Äôhist√≤rics.  
El sistema combina **Venus OS GX Tank 140** per la lectura dels nivells de dip√≤sits, una **Raspberry Pi 4B** per la l√≤gica de control i dashboard, i un **HAT PiRelay-V2** per al control f√≠sic dels rel√©s.

L‚Äôobjectiu √©s automatitzar la maniobra de la bomba segons condicions dels nivells, horaris i manteniment, amb supervisi√≥ des d‚Äôun **dashboard web basat en Streamlit**.

---

## 2. Elements del sistema

### Maquinari
- **Venus OS 3.64** amb **GX Tank 140**.
  - Port 3: sonda de nivell (4-20mA) del dip√≤sit baix.
  - Port 4: sonda de nivell (4-20mA) del dip√≤sit alt.
- **Raspberry Pi 4B** amb Raspberry Pi OS.
- **HAT PiRelay-V2** de SB Components amb 4 rel√©s.
  - Relay 3 ‚Üí GPIO6 (pin 31).
  - Relay 4 ‚Üí GPIO5 (pin 29).

### Programari
- **MQTT** activat al Venus OS (interf√≠cie v2 recomanada).
- **Python 3** amb entorn virtual i llibreries:  
  `streamlit`, `paho-mqtt`, `gpiozero`, `matplotlib`, etc.
- **Streamlit** per al dashboard web.

---

## 3. L√≤gica del sistema

1. **Arrencada programada**:  
   - Per defecte a les **12:00** (configurable entre 11:00 i 14:00).  
   - Activa els rel√©s en funci√≥ dels nivells:  
     - Relay 3 s‚Äôactiva si el dip√≤sit baix est√† > 15%.  
     - Relay 4 s‚Äôactiva si el dip√≤sit alt est√† < 99%.  
   - La maniobra dura m√†xim **3 minuts per defecte** (configurable entre 2 i 5).

2. **Aturada autom√†tica**:  
   - Passats els minuts de durada m√†xima.  
   - O abans si el dip√≤sit baix cau < 15% o el dip√≤sit alt supera 99%.

3. **Maniobra manual**:  
   - Es pot activar des del dashboard amb un bot√≥ lliscant.  
   - Durada m√†xima **10 minuts per defecte** (configurable entre 5 i 30).  
   - Si supera aquest temps sense parada manual, s‚Äôatura autom√†ticament.

4. **Manteniment**:  
   - Si no hi ha hagut cap maniobra amb arrencada en el per√≠ode establert (10 dies per defecte, configurable entre 7 i 15), s‚Äôexecuta una maniobra de manteniment curta (5-15 segons).

5. **Hist√≤ric**:  
   - Es guarda a un **fitxer CSV** (`historic.csv`) amb separador `;`.  
   - Registra: dia/hora inici, final, durada, nivells inicials i finals, i tipus de maniobra (amb arrencada, sense arrencada, manteniment).  
   - Retenci√≥ configurable (2 a 10 anys).

6. **Notificaci√≥ per correu**:  
   - Al finalitzar la maniobra di√†ria, s‚Äôenvia un **email autom√†tic** amb el resultat i totes les dades.  
   - El subject indica: *maniobra bomba amb arrencada*, *sense arrencada* o *manteniment*, seguit de la ubicaci√≥.  
   - El cos cont√© totes les dades guardades al CSV.  
   - Par√†metres configurables: correu destinatari, remitent i contrasenya SMTP.

---

## 4. Dashboard Streamlit

El dashboard t√© **3 pestanyes**:

### üîπ Monitoritzaci√≥
- Gauge del nivell del dip√≤sit alt (%).  
- Gauge del nivell del dip√≤sit baix (%).  
- Indicador LED (vermell/verd) estat de la maniobra (parada/en marxa).  
- Indicadors LED dels rel√©s 3 i 4.  
- Hora i data actual.  
- Hora i data de l‚Äô√∫ltima maniobra i durada.  
- Hora de la propera maniobra programada.  
- Bot√≥ lliscant per maniobra manual.

### üîπ Hist√≤ric
- Gr√†fic amb 3 l√≠nies:  
  - Durada di√†ria de maniobra.  
  - Nivell del dip√≤sit baix al comen√ßar.  
  - Nivell del dip√≤sit alt al comen√ßar.  
- Selector de per√≠ode: 1 mes, 3 mesos, 6 mesos, 1 any, 3 anys, 5 anys, 10 anys (per defecte 1 any).  
- Taula amb les dades dels darrers 30 dies.

### üîπ Par√†metres
- Adre√ßa IP broker MQTT.  
- Hora maniobra (11:00‚Äì14:00, per defecte 12:00).  
- Durada m√†xima maniobra (2‚Äì5 min, per defecte 3).  
- Per√≠ode arrencada manteniment (7‚Äì15 dies, per defecte 10).  
- Temps maniobra manteniment (5‚Äì15 s, per defecte 10).  
- Durada m√†xima maniobra manual (5‚Äì30 min, per defecte 10).  
- Per√≠ode retenci√≥ hist√≤ric (2‚Äì10 anys, per defecte 5).  
- Email destinatari.  
- Email remitent i contrasenya SMTP.  
- Ubicaci√≥ del sistema.

---

## 5. Execuci√≥
El sistema pot arrencar:  
- Manualment amb `start_dashboard.sh`.  
- Autom√†ticament al boot mitjan√ßant `autostart.service` i `install_autostart_service.sh`.

Un script `test_mqtt.py` est√† incl√≤s per verificar la connexi√≥ MQTT i la recepci√≥ de nivells.

---

## 6. Acc√©s
Dashboard disponible a:  
`http://<IP_RASPBERRY>:8501`